!function(a){var b=!1,c=null,d=null,e=null,f={},g={},h=function(a){try{return a.split(";").map(function(a){return a.trim()}).filter(function(a){return!(""===a||a.indexOf("=")<0)}).map(function(a){var b=a.indexOf("=");return{key:a.substring(0,b).trim(),value:a.substring(b+1).trim()}}).reduce(function(a,b){return a[b.key]=i(b.value),a},{})}catch(a){ConnectsIntegrationAPI.writeLogError("RecordingControls: Exception while parsing custom settings: "+a),k("Error when loading component","Custom settings could not be retrieved. Please try again later or contact your administrator.")}},i=function(a){var b;return b="string"==typeof a?a.trim():a,"true"===b?b=!0:"false"===b&&(b=!1),b},j=function(a){if(d)null!=c?a(c):ConnectsIntegrationAPI.getCustomToolbarDefaultSize(ConnectsIntegrationAPI.GENERAL.TOOLBAR_POSITION.AUTO,function(b){b.success?a(b.data.height):(k("Error when loading component","Custom toolbar default size could not be retrieved. Please try again later or contact your administrator."),v.disable())});else{var b=$("html").height();a(b)}},k=function(a,b){d?ConnectsIntegrationAPI.showError("REC-CTRL",a,b):($("#errorTitle").text(a),$("#errorMessage").text(b),$("#errorButton").text("OK"),$("#errorView").show(),$("#errorButton").click(function(){$("#errorView").hide(),$("#errorTitle").text(""),$("#errorMessage").text("")}))},l=function(a){var b=a.split("/");return b[0]+"//"+b[2]},m=function(a){var b,c,d;if(b=!(!window[a]||!window[a].RecordingControlsController),!(c=!!window.RecordingControlsController)&&!b)return void ConnectsIntegrationAPI.writeLogError("RecordingControls:The Apex class was not found. Please specify the namespace.");c?d=window.RecordingControlsController:b&&(d=window[a].RecordingControlsController),e=d},n=function(a){null!=a.ctiData&&o(a.ctiData)},o=function(a){if(null!=a.Channels)for(var b=0;b<a.Channels.length;b++){var c=a.Channels[b];if(c.Name===ConnectsIntegrationAPI.CHANNEL.TYPE.VOICE){c.State!==ConnectsIntegrationAPI.CHANNEL.STATE.LOGOUT||!v.isLoggedIn()&&v.isLoginFailed()!==a.Agent?v.isLoggedIn()||c.State===ConnectsIntegrationAPI.CHANNEL.STATE.LOGOUT||v.login(a.Agent,a.Extension):v.logout(a.Agent,a.Extension);break}}},p=function(a){if(null!=a.Channels)for(var b=0;b<a.Channels.length;b++){var c=a.Channels[b];if(c.Name===ConnectsIntegrationAPI.CHANNEL.TYPE.VOICE){if(c.State===ConnectsIntegrationAPI.CHANNEL.STATE.LOGOUT&&v.isLoggedIn()?v.logout(a.Agent,a.Extension):v.isLoggedIn()||c.State===ConnectsIntegrationAPI.CHANNEL.STATE.LOGOUT||v.login(a.Agent,a.Extension),v.isLoggedIn()&&c.Items.length>0){for(var d=!1,e=0;e<c.Items.length;e++)c.Items[e].State!==ConnectsIntegrationAPI.WORKITEM.STATE.ACTIVE&&c.Items[e].State!==ConnectsIntegrationAPI.WORKITEM.STATE.PAUSED||(d?d.Id>c.Items[e].Id&&(d=c.Items[e]):d=c.Items[e]);d&&q({item:{Id:d.Id}})}break}}},q=function(a){v.isConfigured()&&!v.hasCall()&&v.setHasCall(!0,a.item.Id)},r=function(a){v.isConfigured()&&a.item.Id===v.activeCallId()&&(v.setHasCall(!1),f.writeRecordingLink&&v.isLastCallRecorded()&&v.saveRecordingLink(a.item.CreatedTimeStamp,a.item.Sender,""===a.item.DNIS?a.item.Destination:a.item.DNIS,a.item.Id))},s=function(a){v.isConfigured()&&a.item.Id===v.activeCallId()&&v.isCallRecording(function(b){b&&a.item.CrmId&&0!==a.item.CrmId.length&&v.setCrmId(a.item.CrmId,a.item.Id)})},t=function(){ConnectsIntegrationAPI.onCtiDataUpdate=null,ConnectsIntegrationAPI.onWorkItemConnect=null,ConnectsIntegrationAPI.onWorkItemWrapup=null,ConnectsIntegrationAPI.onWorkItemEnd=null,ConnectsIntegrationAPI.onActivitySave=null,b=!1},u=function(a){if(a.origin===v.getRecordingControlsProxyOrigin()&&a.data&&(0===a.data.indexOf("recordingControls{")||0===a.data.indexOf("recordingControls[{"))){var b=JSON.parse(a.data.substring("recordingControls".length)),c=b.referenceId,d=g[c];if("function"==typeof d){delete b.referenceId;try{d.call(this,b.data)}catch(a){console.log("Exception while executing response callback: "+a)}delete g[c]}}},v=function(){var a=null,b=null,c=!1,d=null,h=!0,i=!1,j=!1,m=!1,n=!1,o=!1,q=!1,r=!1,s="",u=!1,v=!1,w=!1,x=!1,y="",z="",A="",B=!1,C=null,D=!1,E=null,F=null,G=null,H=null,I={container:null,view:{_:null,title:{_:null,indicator:null,content:null},content:null}},J=function(){I.container=$("#content"),I.view._=$("#controlButtonsView"),I.view.recordButton=I.view._.find(".recordButton"),I.view.pauseButton=I.view._.find(".pauseButton"),I.view.resumeButton=I.view._.find(".resumeButton"),I.view.restartButton=I.view._.find(".restartButton"),I.view.deleteButton=I.view._.find(".deleteButton"),I.view.writeMetadataButton=I.view._.find(".writeMetadataButton"),I.view.startSegmentButton=I.view._.find(".startSegmentButton"),I.view.stopSegmentButton=I.view._.find(".stopSegmentButton"),I.view.title.content=I.view._.find(".titleBar .content"),I.view.content=I.view._.find(".viewContent"),I.view.recordButton.click(function(){!h&&oa(I.view.recordButton)&&ma(I.view.recordButton)&&!ta()&&_()}),I.view.pauseButton.click(function(){!h&&ma(I.view.pauseButton)&&aa()}),I.view.resumeButton.click(function(){!h&&ma(I.view.resumeButton)&&ba()}),I.view.restartButton.click(function(){!h&&ma(I.view.restartButton)&&ca()}),I.view.deleteButton.click(function(){!h&&ma(I.view.deleteButton)&&da()}),I.view.writeMetadataButton.click(function(){!h&&ma(I.view.writeMetadataButton)&&ea()}),I.view.startSegmentButton.click(function(){!h&&ma(I.view.startSegmentButton)&&fa()}),I.view.stopSegmentButton.click(function(){!h&&ma(I.view.stopSegmentButton)&&ga()}),L()};$(document).ready(function(){J()}),$(window).on("unload",function(){X(),t()});var K=function(){try{e.retrieveControlButtonsLabels(N,{escape:!1,timeout:1e4})}catch(a){b={},b.RecordingControls="b+s Recording Controls for Calabrio",b.RecordingRecordTitle="Record",b.RecordingRecordText="Toggle Recording",b.RecordingPauseTitle="Pause",b.RecordingPauseText="Pause Recording",b.RecordingResumeTitle="Resume",b.RecordingResumeText="Resume Recording",b.RecordingRestartTitle="Restart",b.RecordingRestartText="Restart Recording",b.RecordingDeleteTitle="Delete",b.RecordingDeleteText="Delete Recording",b.RecordingMetadataTitle="Metadata",b.RecordingMetadataText="Write Metadata",b.RecordingStartTitle="Start Segment",b.RecordingStartText="Start Segment on Recording",b.RecordingStopTitle="Stop Segment",b.RecordingStopText="Stop Segment on Recording",b.RecordingDisabledText="disabled",L()}},L=function(){null!=b&&null!=I.container&&(I.view.recordButton[0].setAttribute("title",b.RecordingRecordText),I.view.pauseButton[0].setAttribute("title",b.RecordingPauseText),I.view.resumeButton[0].setAttribute("title",b.RecordingResumeText),I.view.restartButton[0].setAttribute("title",b.RecordingRestartText),I.view.deleteButton[0].setAttribute("title",b.RecordingDeleteText),I.view.writeMetadataButton[0].setAttribute("title",b.RecordingMetadataText),I.view.startSegmentButton[0].setAttribute("title",b.RecordingStartText),I.view.stopSegmentButton[0].setAttribute("title",b.RecordingStopText),c=!0,ConnectsIntegrationAPI.writeLogDebug("RecordingControlModule initialized"),"function"==typeof d&&(d.call(this),d=null))},M=function(b,c){var d=!c.status||!b;try{a=JSON.parse(b)}catch(a){d=!0}d?(k("Error when loading component","User info could not be retrieved. Please try again later or contact your administrator."),S()):K()},N=function(a,c){var d=!c.status||!a;try{b=JSON.parse(a)}catch(a){d=!0}d?(k("Error when loading component","Custom labels could not be retrieved. Please try again later or contact your administrator."),S()):L()},O=function(){c&&!h&&(la(),I.view.content.show())},P=function(){I.view.content.hide(),h&&(b?I.view.title.content.html(b.RecordingControls):I.view.title.content.html("b+s Recording Controls for Calabrio"))},Q=function(){return I.view._.outerHeight(!0)},R=function(b){if(d=b,f.hasOwnProperty("peripheralId")||(f.peripheralId="0"),f.hasOwnProperty("recordingServer")||(f.recordingServer=""),!f.hasOwnProperty("callStatusInterval")){var c=parseInt(f.callStatusInterval,10);f.callStatusInterval=isNaN(c)?2e3:c}f.hasOwnProperty("userLoginRequired")||(f.userLoginRequired=!1);var g=document.getElementsByClassName("recordingControlsProxy");g.length>0?(F=g[0].contentWindow,G=g[0].src.toLowerCase(),H=l(G)):(ConnectsIntegrationAPI.writeLogError("RecordingControls: Recording Controls Proxy iFrame could not be found."),k("Error when loading component","Recording Controls Proxy iFrame could not be found. Please contact your administrator."));try{e.retrieveUserInfo(M,{escape:!1,timeout:1e4})}catch(b){a={},a.user={},a.user.Alias="",a.user.CommunityNickname="",a.user.FirstName="",a.user.Id="",a.user.LastName="",a.user.Name="",a.user.cnx__Agent_ID__c="",a.user.cnx__Agent_PasswordEncrypted__c="",a.user.cnx__Agent_Phone_Extension__c="",K()}},S=function(){h=!0,P()},T=function(){h=!1,O()},U=function(a){var b={};return b.type=a,b.senderId=z,b.peripheralId=f.peripheralId,b.extension=y,b},V=function(a,b){if(z=a,y=b,!f.userLoginRequired)return j=!0,void Y();var c=U("login");i?ConnectsIntegrationAPI.writeLogDebug("RecordingControls: login request skipped, loggin already in progress"):m===a?ConnectsIntegrationAPI.writeLogDebug("RecordingControls: login request skipped, loggin failed"):(i=!0,sa(c,function(b){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(b)),i=!1,b&&b.data&&"Login was sent successfully"===b.data.status?(j=!0,Y()):(k("Login failed",b.data.status),m=a)}))},W=function(){if(!f.userLoginRequired)return j=!1,m=!1,n=!1,isAuthorized=!1,u=!1,r=!1,o=!1,q=!1,w=!1,void S();var a=U("logout");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),j=!1,m=!1,n=!1,u=!1,r=!1,o=!1,q=!1,w=!1,S()})},X=function(){if(f.userLoginRequired){var a=U("logout");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a))})}j=!1,m=!1,n=!1,u=!1,r=!1,o=!1,q=!1,w=!1,S()},Y=function(){var a=U("config");sa(a,function(a){if(a&&a.data&&a.data.userConfigured){n=!0,f.agentButtons=a.data.buttons,oa(I.view.pauseButton)||(I.view.pauseButton[0].style.display="none"),oa(I.view.resumeButton)||(I.view.resumeButton[0].style.display="none"),oa(I.view.restartButton)||(I.view.restartButton[0].style.display="none"),oa(I.view.deleteButton)||(I.view.deleteButton[0].style.display="none"),oa(I.view.writeMetadataButton)||(I.view.writeMetadataButton[0].style.display="none"),oa(I.view.startSegmentButton)||(I.view.startSegmentButton[0].style.display="none"),oa(I.view.stopSegmentButton)||(I.view.stopSegmentButton[0].style.display="none"),T();var b=ConnectsIntegrationAPI.getCtiData();b&&p(b)}else n=!1,ConnectsIntegrationAPI.writeLogError("RecordingControls: User is not configured on Calabrio."),k("Login failed","User is not configured on Calabrio.")})},Z=function(a){if(!n)return void a(!1);var b=U("call_status");b.ani="",b.dnis="",sa(b,function(b){if(b.data.status&&/is not configured for recording$/.test(b.data.status))return void a(!1);if(b.data.contactId&&b.data.callActive){if("null"===b.data.contactId&&"true"===b.data.callActive)return void a(!1);if("null"===b.data.contactId&&"false"===b.data.callActive)return void a(!1);if("null"!==b.data.contactId&&"true"===b.data.callActive)return void a(!0,b.data.contactId)}a(!1)})},_=function(){var a=U("record");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),q=!0,r&&(u=!0),v=!0,la()})},aa=function(){var a=U("pause");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),w=!0,la()})},ba=function(){var a=U("resume");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),w=!1,la()})},ca=function(){var a=U("restart");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),w=!1,la()})},da=function(){var a=U("delete");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),w=!1,o=!1,q=!1,u=!1,r=!1,la()})},ea=function(a,b,c){if(B!==c){var d=U("metadata");d.key=a,d.value=b,B=c,sa(d,function(a){B=200===a.status&&c,ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a))})}},fa=function(){var a=U("start");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),x=!0,la()})},ga=function(){var a=U("stop");sa(a,function(a){ConnectsIntegrationAPI.writeLogDebug("RecordingControls: "+JSON.stringify(a)),x=!1,la()})},ha=function(a,b,c,d){var g;d!==D&&(D=d,g=ia(f,C),e.writeRecordingLink(A,f.recordingLinkField,g,function(a,b){200!==b.statusCode?ConnectsIntegrationAPI.writeLogError("RecordingControls:Exception while writing recording ("+C+") link into task: "+b.message):ConnectsIntegrationAPI.writeLogDebug("RecordingControls:Recording ("+C+") Link successfully stored to task."),g=null}))},ia=function(a,b){var c,d="https://"+a.recordingServer;return c="string"==typeof a.recordingLinkUrl&&0!==a.recordingLinkUrl.indexOf("/")?"/"+a.recordingLinkUrl:a.recordingLinkUrl,c?d+c+b:d+"/cwfo/apps/Recordings.html?loadContact="+b},ja=function(a,b){a===r&&b===s||(r=a,r?(u=!0,s=b,o=!1,q=!1,B=!1,ra()):(v=ta(),o=!1,q=!1,B=!1,s="",w=!1,x=!1),la())},ka=function(a,b){A=a,ea("sf_id",A,b)},la=function(){j?r?(na(I.view.recordButton,!0),ta()?(qa(w?!1:!0),oa(I.view.deleteButton)&&na(I.view.deleteButton,!0),oa(I.view.restartButton)&&na(I.view.restartButton,!0),oa(I.view.writeMetadataButton)&&na(I.view.writeMetadataButton,!0),w?(na(I.view.pauseButton,!1),oa(I.view.resumeButton)&&na(I.view.resumeButton,!0),na(I.view.startSegmentButton,!1),na(I.view.stopSegmentButton,!1)):(oa(I.view.pauseButton)&&na(I.view.pauseButton,!0),na(I.view.resumeButton,!1),x?(na(I.view.startSegmentButton,!1),oa(I.view.stopSegmentButton)&&na(I.view.stopSegmentButton,!0)):(oa(I.view.startSegmentButton)&&na(I.view.startSegmentButton,!0),na(I.view.stopSegmentButton,!1)))):(oa(I.view.recordButton)&&qa(!1),na(I.view.pauseButton,!1),na(I.view.resumeButton,!1),na(I.view.deleteButton,!1),na(I.view.restartButton,!1),na(I.view.writeMetadataButton,!1),na(I.view.startSegmentButton,!1),na(I.view.stopSegmentButton,!1))):(na(I.view.recordButton,!1),qa(!1),u?v?(oa(I.view.deleteButton)&&na(I.view.deleteButton,!0),oa(I.view.writeMetadataButton)&&na(I.view.writeMetadataButton,!0)):na(I.view.recordButton,!0):(na(I.view.deleteButton,!1),na(I.view.writeMetadataButton,!1)),na(I.view.pauseButton,!1),na(I.view.resumeButton,!1),na(I.view.restartButton,!1),na(I.view.startSegmentButton,!1),na(I.view.stopSegmentButton,!1)):(na(I.view.recordButton,!1),na(I.view.pauseButton,!1),na(I.view.resumeButton,!1),na(I.view.restartButton,!1),na(I.view.deleteButton,!1),na(I.view.writeMetadataButton,!1),na(I.view.startSegmentButton,!1),na(I.view.stopSegmentButton,!1))},ma=function(a){return!a.hasClass("ctrlButtonDisabled")},na=function(a,c){var d=c?"ctrlButton":"ctrlButtonDisabled",e=c?"ctrlButtonDisabled":"ctrlButton";a.hasClass(e)&&(a.removeClass(e),a.addClass(d));var f=a[0].getAttribute("title").indexOf(" ("+b.RecordingDisabledText+")")>-1;c?f&&a[0].setAttribute("title",a[0].getAttribute("title").replace(" ("+b.RecordingDisabledText+")","")):f||a[0].setAttribute("title",a[0].getAttribute("title")+" ("+b.RecordingDisabledText+")")},oa=function(a){return!(a!==I.view.recordButton||!pa("record"))||(!(a!==I.view.pauseButton||!pa("pause"))||(!(a!==I.view.resumeButton||!pa("resume"))||(!(a!==I.view.restartButton||!pa("restart"))||(!(a!==I.view.deleteButton||!pa("delete"))||(!(a!==I.view.writeMetadataButton||!pa("metadata"))||(!(a!==I.view.startSegmentButton||!pa("start"))||!(a!==I.view.stopSegmentButton||!pa("stop"))))))))},pa=function(a){if(f.agentButtons)for(var b=0;b<f.agentButtons.length;b++)if(a===f.agentButtons[b])return!0;return!1},qa=function(a){a?I.view.recordButton.addClass("blink"):I.view.recordButton.removeClass("blink")},ra=function(){function a(){Z(function(b,c){!b&&r?setTimeout(function(){r?a():E=!1},f.callStatusInterval):(o=!0,E=!1,C=c,la())})}E||(E=!0,a())},sa=function(a,b){if(ConnectsIntegrationAPI.writeLogDebug('RecordingControls: Sending recording controls proxy request "'+a.type+'".'),"function"==typeof b)a.referenceId=Date.now()+Math.floor(1e3*Math.random()+1),g[a.referenceId]=b;else{if(void 0!==b&&null!==b)return a.referenceId=-1,void console.log("Parameter callback is not a valid function.");a.referenceId=-1}try{F.postMessage("recordingControls"+JSON.stringify(a),H)}catch(b){ConnectsIntegrationAPI.writeLogError('RecordingControls: Could not send request "'+a.type+'": '+b)}},ta=function(){return o&&!f.onDemand||o&&f.onDemand&&q},ua=function(){return v};return{init:R,enable:T,disable:S,isLoggedIn:function(){return j},isLoginFailed:function(){return m},login:V,logout:W,isConfigured:function(){return n},setHasCall:ja,hasCall:function(){return r},activeCallId:function(){return s},isCallRecording:function(a){function b(a){E?setTimeout(function(){b(a)},1e3):a(o)}b(a)},setCrmId:function(a,b){ka(a,b)},saveRecordingLink:function(a,b,c,d){ha(0,0,0,d)},recordCmd:_,pauseCmd:aa,resumeCmd:ba,restartCmd:ca,deleteCmd:da,writeMetadataCmd:ea,startSegmentCmd:fa,stopSegmentCmd:ga,sendSFDCRequest:sa,show:O,hide:P,getHeight:Q,getRecordingControlsProxyOrigin:function(){return H},isLastCallRecorded:ua}}();a.RecordingControls={},function(){ConnectsIntegrationAPI.waitReady(function(){d=ConnectsIntegrationAPI.isLoadedInGadget(),d&&$("body").addClass("isLoadedInGadget"),j(function(a){c=a}),ConnectsIntegrationAPI.getCustomSettings("RecordingControls",function(a){if(a.success){a.data&&""!==a.data?f=h(a.data):(ConnectsIntegrationAPI.writeLogError("RecordingControls: Custom settings could not be read because the retrieved string is empty. Please check your call center configuration!"),k("Error when loading component","Custom settings could not be read because the retrieved string is empty. Please try again later or contact your administrator.")),m(f.apexNamespace),f.hasOwnProperty("onDemand")||(f.onDemand=!1),f.hasOwnProperty("toolbarFolder")||(f.toolbarFolder="bsRecordingControlsToolbar"),f.hasOwnProperty("recordingLinkField")||(f.recordingLinkField="Description"),f.hasOwnProperty("writeRecordingLink")||(f.writeRecordingLink=!0),f.hasOwnProperty("userIdField")||(f.userIdField="Alias"),f.hasOwnProperty("userPasswordField")||(f.userPasswordField="cnx__Agent_PasswordEncrypted__c");var c=null,d="https://"+f.recordingServer+"/"+f.toolbarFolder+"/RecordingControls.html";try{var e=document.createElement("iframe");e.style.display="none",e.className="recordingControlsProxy",e.src=d,e.onload=function(){c&&(clearInterval(c),c=null),window.addEventListener("message",u,!1);var a=$.Deferred();v.init(function(){v.disable(),a.resolve()}),$.when(a).done(function(){ConnectsIntegrationAPI.onCtiDataUpdate=n,ConnectsIntegrationAPI.onWorkItemConnect=q,ConnectsIntegrationAPI.onWorkItemWrapup=r,ConnectsIntegrationAPI.onWorkItemEnd=r,ConnectsIntegrationAPI.onActivitySave=s,b=!0,ConnectsIntegrationAPI.writeLogDebug("RecordingControls initialized"),v.show();var a=ConnectsIntegrationAPI.getCtiData();a&&p(a)})},document.body.appendChild(e),c=setInterval(function(){ConnectsIntegrationAPI.writeLogError("RecordingControls: Proxy page at "+d+"could not be loaded. Please make sure this page is accessible."),k("Error when loading component","Proxy page at "+d+" could not be loaded. Please make sure this page is accessible."),clearInterval(c),c=null},1e4)}catch(a){ConnectsIntegrationAPI.writeLogError("RecordingControls: Could not load iFrame on "+f.recordingServer+": "+a)}}else ConnectsIntegrationAPI.writeLogError("RecordingControls: Could not get custom settings from integration API: "+a.error),k("Error when loading component","Custom settings could not be retrieved. Please try again later or contact your administrator.")})})}()}(this);